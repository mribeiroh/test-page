<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Run Polaris Test Automation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; }
    .btn { padding: 10px 16px; border-radius: 8px; background: #24292f; color: #fff; border: 0; cursor: pointer; }
    .row { margin: 10px 0; }
    select { width: 100%; max-width: 420px; padding: 8px; }
    #current-status-box { padding:10px; border:1px solid #ccc; border-radius:8px; margin-top:10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; cursor: pointer; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 6px 10px; text-align: left; }
    tr.success { background-color: #d4edda; }
    tr.failure { background-color: #f8d7da; }
    tr.running { background-color: #fff3cd; }
    tr.other   { background-color: #e2e3e5; }
    tr:hover { background-color: #dbeafe; }
    tr.highlight { outline: 2px solid #3b82f6; box-shadow: 0 0 8px #3b82f6; }
    #charts { display: flex; gap: 20px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
    .chart-box { width: 250px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Run Polaris Test Automation</h1>

  <div class="row">
    <label>Select environment:</label><br />
    <select id="env">
      <option value="dev">Development</option>
      <option value="qa">QA</option>
    </select>
  </div>

  <div class="row">
    <button id="run" class="btn">‚ñ∂ Run Workflow</button>
  </div>

  <div class="row">
    <h2>Workflow Status</h2>
    <div id="current-status-box">No workflow triggered yet.</div>
  </div>

  <div class="row">
    <h2>Run History (click row to view details)</h2>
    <table id="history-table">
      <thead>
        <tr>
          <th>Run ID</th>
          <th>Env</th>
          <th>Status</th>
          <th>Conclusion</th>
          <th>GitHub</th>
          <th>Cypress</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="row">
    <h2>Run Results Summary</h2>
    <div id="charts">
      <div class="chart-box">
        <h3>DEV</h3>
        <canvas id="devChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>QA</h3>
        <canvas id="qaChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    let currentRunId = null;
    let devChart = null;
    let qaChart = null;

    async function dispatch() {
      const env = document.getElementById("env").value;

      try {
        const r = await fetch("https://test-page-46f5.vercel.app/api/trigger", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ env })
        });

        const data = await r.json();

        if (r.ok && data.id) {
          currentRunId = data.id;
          document.getElementById("current-status-box").innerHTML =
            `<p>‚è≥ <b>Triggering workflow for ${env.toUpperCase()}‚Ä¶</b></p>`;
          setTimeout(updateCurrentStatus, 3000);
          setTimeout(updateHistoryFromServer, 5000);
        } else {
          document.getElementById("current-status-box").innerHTML =
            `<p style="color:red;">‚ùå ${r.status}: ${data.error || "Unknown error"}</p>`;
        }
      } catch (err) {
        document.getElementById("current-status-box").innerHTML =
          `<p style="color:red;">‚ö†Ô∏è ${err.message}</p>`;
      }
    }

    async function updateCurrentStatus() {
      if (!currentRunId) return;
      try {
        const r = await fetch(`https://test-page-46f5.vercel.app/api/run/${currentRunId}`);
        const data = await r.json();
        const box = document.getElementById("current-status-box");

        if (r.ok) {
          const icon = data.status === "in_progress" ? "‚è≥" :
                       data.conclusion === "success" ? "‚úÖ" :
                       data.conclusion === "failure" ? "‚ùå" :
                       data.conclusion === "cancelled" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è";

          box.innerHTML = `
            <p>${icon} <b>${data.name || "Run " + currentRunId}</b></p>
            <p><b>Environment:</b> ${data.env || "unknown"}</p>
            <p><b>Status:</b> ${data.status}</p>
            <p><b>Conclusion:</b> ${data.conclusion || "pending"}</p>
            <p>
              <a href="${data.url}" target="_blank">üîó GitHub</a>
              ${data.cypressUrl 
                ? ` | <a href="${data.cypressUrl}" target="_blank">üîó Cypress</a>` 
                : ""}
            </p>
          `;

          if (data.status === "queued" || data.status === "in_progress") {
            setTimeout(updateCurrentStatus, 5000);
          } else {
            currentRunId = null;
          }
        } else {
          box.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
        }
      } catch (err) {
        document.getElementById("current-status-box").innerHTML =
          `<p style="color:red;">‚ö†Ô∏è ${err.message}</p>`;
      }
    }

    async function updateHistoryFromServer() {
      try {
        const r = await fetch("https://test-page-46f5.vercel.app/api/history");
        const data = await r.json();
        if (r.ok) {
          renderHistory(data.runs);
          updateCharts(data.runs);
        }
      } catch (err) {
        console.error("History update failed:", err.message);
      }
    }

    function renderHistory(runs) {
      const tbody = document.querySelector("#history-table tbody");
      tbody.innerHTML = runs.map(run => {
        let cls = "other";
        if (run.status === "in_progress" || run.status === "queued") cls = "running";
        if (run.conclusion === "success") cls = "success";
        if (run.conclusion === "failure") cls = "failure";
        if (run.conclusion === "cancelled") cls = "other";
        if (String(run.id) === String(currentRunId)) cls += " highlight";

        return `
          <tr class="${cls}" data-id="${run.id}">
            <td>${run.id}</td>
            <td>${run.env || "unknown"}</td>
            <td>${run.status}</td>
            <td>${run.conclusion || "pending"}</td>
            <td><a href="${run.url}" target="_blank">üîó GitHub</a></td>
            <td>
              ${run.cypressUrl 
                ? `<a href="${run.cypressUrl}" target="_blank">üîó Cypress</a>` 
                : "‚Äî"}
            </td>
          </tr>
        `;
      }).join("");

      document.querySelectorAll("#history-table tbody tr").forEach(row => {
        row.addEventListener("click", () => {
          currentRunId = row.dataset.id;
          updateCurrentStatus();
        });
      });
    }

    function updateCharts(runs) {
      const counts = {
        dev: { success: 0, failure: 0, cancelled: 0, running: 0 },
        qa: { success: 0, failure: 0, cancelled: 0, running: 0 }
      };

      runs.forEach(run => {
        const env = run.env || "unknown";
        if (!counts[env]) return;

        if (run.status === "in_progress" || run.status === "queued") {
          counts[env].running++;
        } else if (run.conclusion === "success") {
          counts[env].success++;
        } else if (run.conclusion === "failure") {
          counts[env].failure++;
        } else if (run.conclusion === "cancelled") {
          counts[env].cancelled++;
        }
      });

      const devCtx = document.getElementById("devChart").getContext("2d");
      const qaCtx = document.getElementById("qaChart").getContext("2d");

      if (devChart) devChart.destroy();
      if (qaChart) qaChart.destroy();

      const chartOptions = {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const value = context.raw;
                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${context.label}: ${value} (${percent}%)`;
              }
            }
          }
        }
      };

      devChart = new Chart(devCtx, {
        type: "pie",
        data: {
          labels: ["Success", "Failure", "Cancelled", "Running"],
          datasets: [{
            data: [counts.dev.success, counts.dev.failure, counts.dev.cancelled, counts.dev.running],
            backgroundColor: ["#28a745", "#dc3545", "#6c757d", "#ffc107"]
          }]
        },
        options: chartOptions
      });

      qaChart = new Chart(qaCtx, {
        type: "pie",
        data: {
          labels: ["Success", "Failure", "Cancelled", "Running"],
          datasets: [{
            data: [counts.qa.success, counts.qa.failure, counts.qa.cancelled, counts.qa.running],
            backgroundColor: ["#28a745", "#dc3545", "#6c757d", "#ffc107"]
          }]
        },
        options: chartOptions
      });
    }

    document.getElementById("run").addEventListener("click", dispatch);

    // Auto-refresh
    setInterval(() => {
      if (currentRunId) updateCurrentStatus();
      updateHistoryFromServer();
    }, 15000);

    // Initial load
    updateHistoryFromServer();
  </script>
</body>
</html>
